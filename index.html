<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>datalib</title>
    <style>
      body { font:15px sans-serif; line-height:1.4em; color:#222 }
      nav {float:left; margin:3em}
      nav div { border-style:solid; border-radius:1em; margin: 1em; padding: 1em}
      nav div table tr td img { width:4em; height:4em; border-radius:1em }
      article table tr td img { width:3em; height:3em; border-radius:1em }
      article {float:left; margin-top:4em; padding:1em; border-style:solid; border-radius:1em}
    </style>
  </head>
  <body>
    <article>
      <h3>when you get "Unknown event 'not-connected'", do remoteStorage.reset(), refresh, click GD connect (you'll get "TypeError: this.rs[options.special] is undefined"), refresh again, click GD connect again, it will work the second time after a reset.</h3> 
      <input type="file" id="files" name="files[]" multiple />
      <output id="list"></output>

      <script>
        function handleFileSelect(evt) {
          var files = evt.target.files; // FileList object

          // files is a FileList of File objects. List some properties.
          var output = [];
          for (var i = 0, f; f = files[i]; i++) {
            output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                        f.size, ' bytes, last modified: ',
                        f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                        '</li>');
            var reader = new FileReader();

            // Closure to capture the file information.
            reader.onload = (function(theFile) {
              return function(e) {
                console.log(e.target.result);
                document.datalib.set(JSON.parse(e.target.result));
              };
            })(f);

            // Read in the file as a data URL.
            reader.readAsText(f);
          }
          document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);
      </script>
    </article>
    <article>
      <input type="submit" value="export" onmousedown="exp();" />
    </article>
  </body>

  <!-- core -->
  <script src="vendor/remotestorage/lib/promising.js"></script>
  <script src="vendor/remotestorage/remotestorage.js"></script>
  <script src="vendor/remotestorage/eventhandling.js"></script>
  <script src="vendor/remotestorage/wireclient.js"></script>
  <script src="vendor/remotestorage/discover.js"></script>
  <script src="vendor/remotestorage/authorize.js"></script>
  <script src="vendor/remotestorage/access.js"></script>
  <script src="vendor/remotestorage/env.js"></script>

  <!-- widget -->
  <script src="vendor/remotestorage/i18n.js"></script>
  <script src="vendor/remotestorage/assets.js"></script>
  <script src="vendor/remotestorage/widget.js"></script>
  <script src="vendor/remotestorage/view.js"></script>
  
  <!-- baseclient -->
  <script src="vendor/remotestorage/lib/tv4.js"></script>
  <script src="vendor/remotestorage/lib/Math.uuid.js"></script>
  <script src="vendor/remotestorage/baseclient.js"></script>
  <script src="vendor/remotestorage/baseclient/types.js"></script>

  <!-- caching -->
  <script src="vendor/remotestorage/caching.js"></script>
  <script src="vendor/remotestorage/sync.js"></script>
  <script src="vendor/remotestorage/cachinglayer.js"></script>
  <script src="vendor/remotestorage/indexeddb.js"></script>
  <script src="vendor/remotestorage/localstorage.js"></script>
  <script src="vendor/remotestorage/inmemorystorage.js"></script>

  <!-- the rest: -->
  <script src="vendor/remotestorage/modules.js"></script>
  <script src="vendor/remotestorage/debug/inspect.js"></script>
  <script src="vendor/remotestorage/legacy.js"></script>
  <script src="vendor/remotestorage/googledrive.js"></script>
  <script src="vendor/remotestorage/dropbox.js"></script>
  <script>remoteStorage = new RemoteStorage();
    </script>
  <script>
    var data = {}, foldersPending = 0, documentsPending = 0, modules = {
      "articles":true,"bookmarks":true,"binaryTest":true,"credentials-sockethub":true,"code":true,"contacts":true,"email":true,"credentials-twitter":true,
      "documents":true,"events":true,"feeds":true,"gruppenkasse":true,"money":true,"inbox":true,"messages":true,"notes":true,"myfavoritedrinks":true,
      "pictures":true,"playlists":true,"presentations":true,"rss":true,"public":true,"sandwiches":true,"sharedstuff":true,"sockethub":true,"songs":true,
      "tasks":true,"todomvc":true,"todo-list":true,"tutorial":true
    };
    function getEverything(prefix) {
      foldersPending++;
      remoteStorage.scope('/').getListing(prefix).then(function(listing) {
        console.log(prefix, listing);
        for (i in listing) {
          if(i.substr(-1) === '/') {
            console.log('descending into', prefix+i);
            getEverything(prefix+i);
          } else {
            documentsPending++;
            remoteStorage.scope('/').getFile(prefix+i).then((function(closurePath) {
              return function(obj) {
                documentsPending--;
                data[closurePath] = obj;
              };
            })(prefix+i), function(err) {
              console.log('error in getEverything', err);
              documentsPending--;
            });
          }
        }
        foldersPending--;
      }, function(err) {
        console.log('error in getEverything', err);
        foldersPending--;
      });
    }
    function d(p) {
      p.then(function(a) {
        console.log(a);
      }, function(a) {
        console.log(a);
      });
    }
    remoteStorage.setApiKeys('googledrive', {
      //see https://console.developers.google.com/project/appunhosted/apiui/credential
      //and https://code.google.com/apis/console/b/0/?noredirect&pli=1#project:709507725318:overview
      client_id: '709507725318-3mt4ke1d4tvkc7ktbjvru3csif4nsk67.apps.googleusercontent.com'
    });
    remoteStorage.displayWidget();
    //remoteStorage.access.claim('*', 'rw');
    //getEverything('');
    //remoteStorage.scope('/').cache('');
    for(i in modules) {
      remoteStorage.access.claim(i, 'rw');
      remoteStorage.scope('/'+i+'/').cache('');
      getEverything(i+'/');
    }
  </script>
</html>